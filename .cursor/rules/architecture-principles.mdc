---
alwaysApply: true
---

# Architecture Principles

## Принципы архитектуры проекта

### Слоистая архитектура (Layered Architecture)
- **API Layer** (`backend/api/` + `backend/routes/`) - только обработка HTTP запросов/ответов
- **Service Layer** (`backend/services/`) - вся бизнес-логика
- **AI Layer** (`backend/ai/`) - интеграция с AI сервисами
- **Clients Layer** (`backend/clients/`) - внешние API клиенты
- **Data Layer** (`backend/database/`) - работа с БД

### Правила разделения ответственности

#### API Layer (Роутеры)
- ✅ Только валидация входных данных (Pydantic)
- ✅ Вызов сервисов
- ✅ Формирование HTTP ответов
- ❌ НЕ содержит бизнес-логику
- ❌ НЕ содержит прямые вызовы БД (кроме простых CRUD через db)
- ❌ НЕ содержит AI логику

#### Service Layer
- ✅ Вся бизнес-логика
- ✅ Оркестрация вызовов AI и БД
- ✅ Обработка ошибок бизнес-логики
- ✅ Переиспользование между роутерами
- ❌ НЕ содержит HTTP специфику
- ❌ НЕ содержит прямые SQL запросы (используй методы db)

#### AI Layer
- ✅ Интеграция с OpenAI/HeyGen
- ✅ Промпты и шаблоны
- ✅ Кэширование AI ответов
- ❌ НЕ содержит бизнес-логику
- ❌ НЕ знает о структуре БД

#### Data Layer
- ✅ Абстракция над БД
- ✅ CRUD операции
- ✅ Автовыбор БД (PostgreSQL/SQLite)
- ❌ НЕ содержит бизнес-логику

### Принципы добавления нового функционала

#### Новый API endpoint
1. Добавить роутер в `backend/api/` или `backend/routes/`
2. Использовать существующий сервис или создать новый в `backend/services/`
3. Использовать Pydantic модели из `backend/models/`
4. Подключить роутер в `backend/main.py`

#### Новый сервис
1. Создать файл в `backend/services/`
2. Использовать существующие сервисы для переиспользования
3. Использовать `backend/database/db` для работы с БД
4. Использовать `backend/ai/` для AI функционала

#### Новый формат экспорта
1. Создать модуль в `backend/services/export/`
2. Добавить метод в `ExportService` как фасад
3. Использовать существующие утилиты из `backend/utils/`

#### Новый внешний API клиент
1. Создать клиент в `backend/clients/`
2. Использовать настройки из `backend/config/settings.py`
3. Обрабатывать ошибки и таймауты
4. Создать сервис-обертку в `backend/services/` если нужна бизнес-логика

### Структура файлов

#### Backend
- `backend/api/` - роутеры для основных сущностей (courses, modules, lessons)
- `backend/routes/` - роутеры для специфичных функций (video, assets)
- `backend/services/` - бизнес-логика, один сервис = один файл
- `backend/services/export/` - модули экспорта (markdown, html, pptx, scorm)
- `backend/ai/` - AI интеграция
- `backend/clients/` - внешние API клиенты
- `backend/config/` - централизованные настройки
- `backend/database/` - работа с БД
- `backend/models/` - Pydantic модели
- `backend/utils/` - утилиты

#### Frontend
- `frontend/src/pages/` - страницы приложения
- `frontend/src/components/` - переиспользуемые компоненты
- `frontend/src/api/` - API клиент
- `frontend/src/config/` - конфигурация

### Запрещенные практики

- ❌ Прямые SQL запросы в роутерах или сервисах (используй методы db)
- ❌ Бизнес-логика в роутерах
- ❌ Дублирование кода между сервисами (выноси в утилиты)
- ❌ Прямые вызовы внешних API из роутеров (используй клиенты)
- ❌ Хардкод настроек (используй `backend/config/settings.py`)
- ❌ Смешивание слоев (API не должен знать о БД структуре)

### Рекомендуемые практики

- ✅ Использовать существующие сервисы для переиспользования
- ✅ Создавать новые сервисы для новой функциональности
- ✅ Использовать Pydantic модели для валидации
- ✅ Логировать важные действия через logger
- ✅ Обрабатывать ошибки с правильными HTTP статусами
- ✅ Использовать async функции для всех endpoints
- ✅ Документировать сложную логику
