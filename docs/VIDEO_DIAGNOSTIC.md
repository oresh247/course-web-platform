# Инструкция по диагностике проблем с просмотром и скачиванием видео

## 1. Запуск тестового скрипта

### Вариант A: Автоматический поиск всех уроков с видео
```bash
cd backend
python test_video_diagnostic.py
```

Скрипт автоматически найдет все уроки с видео в базе данных и протестирует их.

### Вариант B: Тестирование конкретного урока
```bash
cd backend
python test_video_diagnostic.py <course_id> <module_number> <lesson_index>
```

**Пример:**
```bash
python test_video_diagnostic.py 3 1 0
```

Это протестирует урок с ID курса=3, модуль=1, урок=0.

## 2. Что проверяет скрипт:

1. ✅ Получение информации о видео из API (`/api/video/lesson/{course_id}/{module_number}/{lesson_index}/info`)
2. ✅ Проверка статуса видео в HeyGen (`/api/video/status/{video_id}`)
3. ✅ Доступность URL для скачивания (HEAD запрос)

## 3. Диагностика в браузере:

### Шаг 1: Откройте консоль разработчика (F12)

### Шаг 2: Перейдите на страницу с уроками (например, `/courses/3`)

### Шаг 3: Проверьте логи в консоли:

**При загрузке урока:**
- `Ответ API информации о видео:` - должен показать данные о видео
- `Информация о видео загружена:` - должна показать структуру данных

**При отображении кнопок:**
- `LessonItem videoInfo:` - подробная информация о видео для каждого урока
- Если кнопки не показываются:
  - `Кнопки не показываются, причина:` - объяснит почему

**При нажатии на кнопки:**
- `Кнопка "Смотреть" нажата` - должно показать videoInfo
- `handleWatchVideo вызвана` - подтверждение вызова функции
- `Открытие видео по URL:` - должен показать URL

## 4. Возможные проблемы и решения:

### Проблема 1: API возвращает `data: null`
**Причина:** Информация о видео не сохранена в базе данных
**Решение:** 
- Убедитесь, что видео было сгенерировано
- Проверьте, что при завершении генерации вызывается сохранение в БД
- Запустите тестовый скрипт для проверки сохранения

### Проблема 2: `video_download_url` пустой
**Причина:** URL для скачивания не был сохранен или не получен от HeyGen
**Решение:**
- Проверьте статус видео: должно быть `completed`
- Проверьте логи backend при обновлении статуса видео
- Убедитесь, что HeyGen API возвращает `download_url`

### Проблема 3: URL не открывается/не скачивается
**Причина:** URL невалидный или недоступен
**Решение:**
- Запустите тестовый скрипт для проверки доступности URL
- Проверьте CORS настройки
- Убедитесь, что URL HeyGen еще действителен (может истечь)

### Проблема 4: Кнопки не отображаются
**Проверьте в консоли:**
- `video_status` должен быть `'completed'`
- `video_download_url` должен быть непустой строкой
- Данные должны загружаться при монтировании компонента

## 5. Проверка в БД напрямую:

### SQLite:
```bash
sqlite3 backend/courses.db
```
```sql
SELECT course_id, module_number, lesson_index, video_id, video_status, video_download_url 
FROM lesson_contents 
WHERE video_id IS NOT NULL;
```

### PostgreSQL:
```sql
SELECT course_id, module_number, lesson_index, video_id, video_status, video_download_url 
FROM lesson_contents 
WHERE video_id IS NOT NULL;
```

## 6. Ручная проверка API:

### Получить информацию о видео:
```bash
curl http://localhost:8000/api/video/lesson/3/1/0/info
```

### Проверить статус видео:
```bash
curl http://localhost:8000/api/video/status/<video_id>
```

### Проверить статистику кэша:
```bash
curl http://localhost:8000/api/video/cache/stats
```

## 7. Что делать дальше:

1. Запустите тестовый скрипт
2. Проверьте вывод в консоли браузера
3. Проверьте логи backend сервера
4. Сообщите результаты диагностики для дальнейшей помощи
