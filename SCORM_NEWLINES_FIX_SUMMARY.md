# Исправление переносов строк в SCORM и HTML экспорте

## Проблема
При выгрузке курсов в форматы SCORM 1.2 и SCORM 2004 в некоторых уроках символы переноса строки `\n` не преобразовывались в HTML-переносы, что приводило к отображению кода и текста в одну строку.

**Пример проблемы:**
```
from selenium import webdriver\n\ndriver = webdriver.Chrome()\ndriver.get('http://example.com')
```

## Причина
Код использовал экранированные строковые литералы `"\\n"` вместо фактических символов переноса строки `"\n"`. Кроме того, порядок операций был неправильным - HTML теги `<br>` экранировались функцией `escape_xml()`.

## Решение

### 1. Исправлен файл `backend/services/export/scorm.py`
- Изменено: `split("\\n\\n")` → `split("\n\n")`
- Изменено: `replace('\\n', '<br>')` → правильный порядок обработки
- Добавлен правильный порядок: сначала экранирование HTML, затем замена `\n` на `<br>`

### 2. Исправлен файл `backend/services/export/html.py`
- Добавлен импорт `html` модуля для экранирования
- Исправлена обработка контента в функциях `export_module_html()` и `export_lesson_html()`
- Применен тот же правильный порядок обработки

### 3. Добавлен тестовый скрипт
- Создан `backend/tools/test_scorm_newlines.py` для автоматической проверки
- Тесты проверяют:
  - ✅ Одиночные `\n` заменяются на `<br>`
  - ✅ Двойные `\n\n` создают отдельные параграфы
  - ✅ Код в `<pre>` блоках сохраняет переносы строк
  - ✅ HTML теги не экранируются дважды

## Результат

### До исправления:
```html
<p>Первая строка&lt;br&gt;Вторая строка&lt;br&gt;Третья строка</p>
```
Отображалось: `Первая строка<br>Вторая строка<br>Третья строка` (буквально)

### После исправления:
```html
<p>Первая строка<br>Вторая строка<br>Третья строка</p>
```
Отображается правильно с переносами строк.

### Для кода:
```html
<pre><code>from selenium import webdriver

driver = webdriver.Chrome()
driver.get('http://example.com')
assert 'Example Domain' in driver.title
driver.quit()</code></pre>
```
Код отображается с правильными переносами строк.

## Затронутые форматы экспорта
- ✅ SCORM 1.2
- ✅ SCORM 2004
- ✅ HTML (экспорт модулей и уроков)
- ✅ Markdown (не требует изменений, работает корректно)

## Тестирование

Запуск тестов:
```bash
python3 backend/tools/test_scorm_newlines.py
```

Результат: **Все тесты пройдены успешно ✅**

## Коммиты
1. `ef42acd` - Исправление обработки переносов строк в SCORM и HTML экспорте
2. `ae4bbe2` - Исправление порядка обработки HTML экранирования и переносов строк

## Ветка
`cursor/scorm-bb0a`

## Как проверить
1. Создайте курс с уроками, содержащими код с переносами строк
2. Экспортируйте курс в SCORM 1.2 или SCORM 2004
3. Откройте HTML файлы уроков в браузере
4. Убедитесь, что:
   - Текст с переносами отображается корректно
   - Код в блоках отображается с правильными переносами строк
   - Нет символов `\n` или `&lt;br&gt;` в отображаемом контенте
